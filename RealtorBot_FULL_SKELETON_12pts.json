{
  "name": "RealtorBot_FULL_SKELETON_12pts",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "id": "218783",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [
        200,
        100
      ]
    },
    {
      "parameters": {
        "functionCode": "// Extract chatId, user, text/voice/file\nconst m = $json.message || $json;\nreturn [{ json: { chatId: m.chat?.id, user: m.from, text: m.text || '', voice: m.voice || null, document: m.document || null, photo: m.photo || null } }];"
      },
      "id": "672706",
      "name": "Normalize",
      "type": "n8n-nodes-base.function",
      "typeVersion": 2,
      "position": [
        200,
        260
      ]
    },
    {
      "parameters": {
        "functionCode": "// Compute trialActive and gate based on user row (to be filled from DB)\nconst u = $json.userRow || {};\nlet trialActive = true; // placeholder\nlet subscription = 'inactive';\nreturn [{ json: { ...$json, trialActive, subscription, gate: trialActive || subscription==='active' } }];"
      },
      "id": "768019",
      "name": "TrialGate",
      "type": "n8n-nodes-base.function",
      "typeVersion": 2,
      "position": [
        200,
        420
      ]
    },
    {
      "parameters": {
        "operation": "chat",
        "model": "gpt-4o-mini",
        "systemMessage": "–¢—ã –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä. –í–µ—Ä–Ω–∏ JSON: {\"type\":\"command|general\",\"command\":\"/start|/help|/tarif|/privacy|/dobavit|/klienty|null\"}",
        "prompt": "={{$json.text}}",
        "responseFormat": "json"
      },
      "id": "349754",
      "name": "Classifier",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 4,
      "position": [
        200,
        580
      ]
    },
    {
      "parameters": {
        "value1": "={{$json.command}}",
        "rules": [
          {
            "operation": "equal",
            "value": "/start"
          },
          {
            "operation": "equal",
            "value": "/help"
          },
          {
            "operation": "equal",
            "value": "/tarif"
          },
          {
            "operation": "equal",
            "value": "/privacy"
          },
          {
            "operation": "equal",
            "value": "/dobavit"
          },
          {
            "operation": "equal",
            "value": "/klienty"
          }
        ]
      },
      "id": "479699",
      "name": "Switch Command",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 2,
      "position": [
        200,
        740
      ]
    },
    {
      "parameters": {
        "chatId": "={{$json.chatId}}",
        "text": "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –¢—Ä–∏–∞–ª 3 –¥–Ω—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –ö–æ–º–∞–Ω–¥—ã: /help /tarif /privacy"
      },
      "id": "328174",
      "name": "Send /start",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        200,
        900
      ]
    },
    {
      "parameters": {
        "chatId": "={{$json.chatId}}",
        "text": "–ö–æ–º–∞–Ω–¥—ã: /start /help /tarif /privacy /dobavit /klienty. –ü–∏—à–∏ —Ç–µ–∫—Å—Ç–æ–º –∏–ª–∏ –≥–æ–ª–æ—Å–æ–º."
      },
      "id": "140436",
      "name": "Send /help",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        200,
        1060
      ]
    },
    {
      "parameters": {
        "chatId": "={{$json.chatId}}",
        "text": "–¢–∞—Ä–∏—Ñ—ã: —Ç—Ä–∏–∞–ª 3 –¥–Ω—è. –ü–æ–¥–ø–∏—Å–∫–∞ ‚Äî 2900‚ÇΩ/–º–µ—Å. –û–ø–ª–∞—Ç–∞: /oplata (–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä)."
      },
      "id": "962913",
      "name": "Send /tarif",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        200,
        1220
      ]
    },
    {
      "parameters": {
        "chatId": "={{$json.chatId}}",
        "text": "–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ (—Å—Å—ã–ª–∫–∞). –ö–Ω–æ–ø–∫–∞ —Å–æ–≥–ª–∞—Å–∏—è –∏ –ø—Ä–∞–≤–æ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ."
      },
      "id": "580952",
      "name": "Send /privacy",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        200,
        1380
      ]
    },
    {
      "parameters": {
        "url": "={{$json.fileUrl || ''}}",
        "responseFormat": "file",
        "options": {}
      },
      "id": "907045",
      "name": "Get Voice File",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        200,
        1540
      ]
    },
    {
      "parameters": {
        "operation": "audioTranscription",
        "model": "whisper-1"
      },
      "id": "53099",
      "name": "Transcribe Voice",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 4,
      "position": [
        200,
        1700
      ]
    },
    {
      "parameters": {
        "operation": "chat",
        "model": "gpt-4o-mini",
        "systemMessage": "–¢—ã ‚Äî –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ä–∏–µ–ª—Ç–æ—Ä–∞ –°–ü–±. –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏, –∏–ø–æ—Ç–µ–∫–µ, –¥–æ–∫—É–º–µ–Ω—Ç–∞–º. –°–æ–±–ª—é–¥–∞–π /privacy.",
        "prompt": "={{$json.text}}"
      },
      "id": "714598",
      "name": "Realtor Agent",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 4,
      "position": [
        200,
        1860
      ]
    },
    {
      "parameters": {
        "chatId": "={{$json.chatId}}",
        "text": "–¢—Ä–∏–∞–ª –∑–∞–≤–µ—Ä—à—ë–Ω. –û—Ñ–æ—Ä–º–∏ –ø–æ–¥–ø–∏—Å–∫—É: /tarif."
      },
      "id": "88543",
      "name": "Send Paywall",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        200,
        2020
      ]
    },
    {
      "parameters": {
        "url": "={{$env.SUPABASE_URL}}/rest/v1/users",
        "method": "POST",
        "jsonParameters": true,
        "headerParametersUi": {
          "parameter": []
        },
        "options": {}
      },
      "id": "429261",
      "name": "Supabase Upsert User",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        200,
        2180
      ]
    },
    {
      "parameters": {
        "url": "={{$env.SUPABASE_URL}}/rest/v1/messages",
        "method": "POST",
        "jsonParameters": true,
        "headerParametersUi": {
          "parameter": []
        },
        "options": {}
      },
      "id": "827980",
      "name": "Supabase Log Message",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        200,
        2340
      ]
    },
    {
      "parameters": {
        "url": "={{$env.SUPABASE_URL}}/rest/v1/clients",
        "method": "POST",
        "jsonParameters": true,
        "headerParametersUi": {
          "parameter": []
        },
        "options": {}
      },
      "id": "792564",
      "name": "Supabase Upsert Client",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        200,
        2500
      ]
    },
    {
      "parameters": {
        "url": "https://api.perplexity.ai/chat/completions",
        "method": "POST",
        "jsonParameters": true,
        "headerParametersUi": {
          "parameter": []
        },
        "options": {}
      },
      "id": "746593",
      "name": "Perplexity Search",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        200,
        2660
      ]
    },
    {
      "parameters": {
        "url": "={{$json.mapApiUrl || ''}}",
        "method": "GET",
        "options": {}
      },
      "id": "518783",
      "name": "2GIS / Yandex Geocoder",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        200,
        2820
      ]
    },
    {
      "parameters": {
        "operation": "create",
        "calendar": "",
        "additionalFields": {}
      },
      "id": "68222",
      "name": "Google Calendar Create Event",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 3,
      "position": [
        200,
        2980
      ]
    },
    {
      "parameters": {
        "functionCode": "// Build .ics text file\nreturn items.map(item => ({ json: { ...item.json, ics: 'BEGIN:VCALENDAR\\n...END:VCALENDAR' } }));"
      },
      "id": "202978",
      "name": "ICS Generator",
      "type": "n8n-nodes-base.function",
      "typeVersion": 2,
      "position": [
        200,
        3140
      ]
    },
    {
      "parameters": {
        "operation": "chat",
        "model": "gpt-4o-mini",
        "systemMessage": "–ò–∑–≤–ª–µ–∫–∏ –ø–æ–ª—è –¥–æ–≥–æ–≤–æ—Ä–∞ (–§–ò–û, –∞–¥—Ä–µ—Å, —Å—É–º–º–∞, –¥–∞—Ç—ã) –∏ –≤–µ—Ä–Ω–∏ JSON.",
        "prompt": "={{$json.extractedText || ''}}"
      },
      "id": "993245",
      "name": "Doc Extract",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 4,
      "position": [
        200,
        3300
      ]
    },
    {
      "parameters": {
        "url": "={{$env.RU_STORAGE_UPLOAD_URL || ''}}",
        "method": "POST",
        "sendBinaryData": true,
        "headerParametersUi": {
          "parameter": []
        },
        "options": {}
      },
      "id": "748531",
      "name": "File to Storage (RU)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        200,
        3460
      ]
    },
    {
      "parameters": {
        "functionCode": "// Mark consent_accepted_at\nreturn [{ json: { ...$json, consent_accepted_at: new Date().toISOString() } }];"
      },
      "id": "663008",
      "name": "Consent Capture",
      "type": "n8n-nodes-base.function",
      "typeVersion": 2,
      "position": [
        200,
        3620
      ]
    },
    {
      "parameters": {
        "url": "={{$env.SUPABASE_URL}}/rest/v1/clients",
        "method": "DELETE",
        "headerParametersUi": {
          "parameter": []
        },
        "options": {}
      },
      "id": "405893",
      "name": "Delete My Data",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        200,
        3780
      ]
    },
    {
      "parameters": {
        "chatId": "={{$json.chatId}}",
        "text": "={{$json.text || 'OK'}}"
      },
      "id": "236810",
      "name": "Telegram Send",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        200,
        3940
      ]
    }
  ],
  "connections": {},
  "active": false,
  "settings": {},
  "staticData": null,
  "pinData": {}
}